# 🧠 design.md — 方案设计规划模板（架构无关 · 可在不同工程落地）

> **定位**：这是一个“设计规划模板”，用于规范化大模型在**不同项目/不同架构**中对复杂需求进行分析、拆分与落地设计的过程。  
> **重要声明**：本模板**不预设具体技术栈或架构模式**（如 Clean Architecture、MVVM、Redux 等），必须**以项目实际为准**（从 `README.md` / `constitution.md` / 代码仓库中观测并得出）。  
> **目标**：输出结构清晰、可维护、可验证、可逐步交付的技术方案，避免过度设计，保证跨工程复用。

---

## 0. 元信息（Meta）

- **Feature / Bug 名称**：`<title>`
- **Spec 路径**：`spec/<feature-or-bug-name>/design.md`
- **版本 / 日期**：`vX.Y · YYYY-MM-DD`
- **关联**：`requirements.md`、`tasks.md`、项目 `README.md`、`constitution.md`
- **所有者 / 评审人**：`<owner>` / `<reviewers>`
- **范围声明（Scope / Non-goals）**
    - In Scope：`<本次包含>`
    - Out of Scope：`<明确不做>`

---

## 1. 项目基线与约束（Project Baseline & Constraints）

> **目的**：在不假设任何架构的前提下，**先识别现状**，再在现状上设计。

- **架构基线（从仓库与文档“观察”得出）**
    - 客户端平台/框架：`<iOS/Android/Flutter/React Native/…>`
    - 层次/模块边界（如“是否存在数据层/领域层/展示层、或按功能域拆分”等）：`<观察结果>`
    - 状态管理/导航/网络/存储/构建体系：`<观察结果>`
    - 现有约定与规范（命名、目录、代码风格、国际化、日志等）：`<观察结果>`
- **外部依赖与环境**：后端/三方 SDK/网关/消息系统/配置中心/特性开关
- **关键约束**：性能、安全、合规、端版本、离线、灰度/回滚、发布渠道
- **假设 & 待确认（Assumptions & Open Questions）**：`<列出验证路径与截止时间>`

> 产出要求：**不得臆造**仓库结构与技术选型；如信息缺失，写明“待确认”并给出获取路径。

---

## 2. 目标与成功标准（Goals & Exit Criteria）

- **业务/用户目标**：`<与 requirements.md 对齐的可度量目标>`
- **技术目标**：可运行性、可维护性、可观测性、可回滚性
- **退出标准（验收门槛）**：关键用例覆盖、错误率阈值、性能目标、演示检查点

---

## 3. 渐进式交付策略（Progressive Strategy · Mock → Real）

> **要求**：按阶段交付，**每个 Phase 可运行、可测试、可回滚**。先 Mock 后真实接口，支持按环境/开关切换。

| Phase | 目标 | 主要内容 | 依赖 | 演示与验收 | 回滚点 |
|------:|------|----------|------|------------|--------|
| 1 | 本地可运行 | UI/交互骨架、临时数据/Stub/Mock | 无/低 | 可操作 Demo、截图/录屏 | 移除功能开关 |
| 2 | 流程串联 | 表单/校验/导航/错误态 | 交互稿/设计稿 | 用例通过、无阻塞 | 关闭开关 |
| 3 | 数据落地 | 本地存储/缓存/离线恢复 | 存储方案 | 断网/恢复验证 | 数据迁移回滚 |
| 4 | 真正集成 | API/事件/消息/推送/轮询 | 后端/网关 | Stage 验收通过 | 版本回退 |

- **Mock 计划**：Mock 数据位于 `<项目约定目录>`；字段/类型/可空性与协议一致；切换策略 `<配置/依赖注入/构建参数>`
- **特性开关（Feature Flags）**：`<开关名称>`、默认值、灰度策略、紧急关闭路径
- **可验证行为/完成标准**：每个 Phase 指定“可操作路径、期望状态/UI 变化、日志/埋点验证项”
- **定时/实时策略（如需）**：轮询间隔或推送触发、并发/取消策略、前后台切换行为

### Phase 详情块（为每个 Phase 复制一份）

> 该块用于将“表格中的一行”展开成可落地的执行与验收单元，确保每个 Phase 都可运行、可演示、可验收、可回滚。

#### Phase <编号> — <标题>
- 目标（Goals）
  - `<本阶段要达成的业务/技术目标>`
  - 完成定义（DoD）：`<可度量标准与退出门槛>`
- 范围（Scope）
  - In Scope：`<本阶段包含>`
  - Out of Scope：`<明确不做>`
- 依赖与开关（Dependencies & Flags）
  - Feature Flag：`<名称>`（默认 on/off，紧急关闭路径）
  - Mock 策略：`<数据来源/文件路径/切换方式>`
  - 外部依赖：`<后端/SDK/配置/账号/测试数据>`
- 实现方案（Implementation）
  - UI/页面/组件（含路径）：`<lib/...>`
  - 状态管理/控制器：`<类/Provider/Store 名称>`
  - 领域用例（Use Cases）：`<用例清单>`
  - 数据模型与映射：`<Domain ↔ DTO 映射/默认值/可空性>`
  - 合同/接口：`<HTTP/gRPC/事件，端点/协议/鉴权/幂等>`
  - 本地存储与迁移：`<表/索引/迁移脚本/回滚>`
  - 定时/实时：`<轮询间隔/触发/取消/前后台切换规则>`
  - 错误处理：`<分类/重试/退避/兜底/局部失败策略>`
- 验收与演示（Acceptance & Demo）
  - Demo 路径：`<从哪里进入，点击什么，期望看到什么>`
  - 期望：`<UI/状态变化/接口调用/本地数据/日志>`
  - 观测：`<日志/埋点/指标/控制台输出>`
- 测试计划（Testing）
  - 自动化：`<单元/集成/E2E：覆盖点与命令>`
  - 手工用例：`<编号/前置/步骤/期望/截图或录屏>`
- 回滚策略（Rollback）
  - `</开关回退/版本回退/数据回滚路径>`
- 风险与缓解（Risks & Mitigations）
  - `<风险项：影响/概率/缓解措施>`
- 影响评估（Impact）
  - 受影响文件/目录：`<新增/修改/删除的路径清单>`
  - 构建/配置/资源变更：`<脚本/资产/国际化>`
- 退出清单（Exit Checklist）
  - [ ] 代码通过 analyze/lint/format
  - [ ] 自动化测试通过（如缺失，提供手工用例与录屏）
  - [ ] 文档更新（requirements/design/tasks/变更日志）
  - [ ] Feature Flag 默认行为正确、可热关
  - [ ] 性能/内存/功耗无回退（或记录基线对比）
  - [ ] 安全/权限/合规项确认
  - [ ] 日志/埋点接入并校验

---

## 4. 方案概要（Solution Overview）

> **在“基线”之上做最小增量设计**，明确**新/改/复用**的边界，避免过度设计。

- **设计思路**：`<为何这样拆分；备选方案对比与取舍（Trade-offs）>`
- **影响面**：模块/页面/接口/数据结构/构建配置
- **兼容性**：向后兼容策略、默认行为、降级策略
- **观测与可维护性**：日志、埋点、指标、告警

---

## 5. 模块与调用关系（Modules & Call Flows）

> **不绑定具体模式**。用**实际项目的模块边界**表达。

- **模块清单（新/改/复用）**  
  | 模块/子系统 | 角色与职责 | 新增/修改/复用 | 对外接口（入/出） |
  |-------------|------------|----------------|------------------|
  | … | … | 新增 | … |
- **核心调用链**（文字/ASCII/时序图均可）  
  `屏幕/组件 → 控制器/状态管理 → 业务编排 → 数据访问/本地/远程 → 模型/映射 → 返回 UI`

- **状态机（如需）**
    - 状态枚举、转移条件、并发/重入策略、错误态处理

 - **分层架构（可选示例）**
   
   ```
   ┌─────────────────────────────────────────┐
   │         Presentation Layer              │
   │  (UI + State Management)               │
   └─────────────────────────────────────────┘
                       ↓
   ┌─────────────────────────────────────────┐
   │          Domain Layer                   │
   │     (Business Logic + Use Cases)        │
   └─────────────────────────────────────────┘
                       ↓
   ┌─────────────────────────────────────────┐
   │           Data Layer                    │
   │  (Repository + Data Sources + Models)   │
   └─────────────────────────────────────────┘
   ```
   
   - 目录建议（按项目风格调整）：`features/<feature>/{presentation|domain|data}/…` 或 `modules/<domain>/…`

---

## 6. 数据与模型（Data & Models）

> **描述“事实模型”与“传输模型”的区别与映射**；**显式单位/时区/可空性/默认值**。

- **领域实体（Domain/事实模型）**：字段、约束、不变量
- **DTO/传输模型 ↔ 领域模型映射表**  
  | 字段 | DTO | Domain | 单位/默认值 | 兼容性 |
  |------|-----|--------|-------------|--------|
  | … | … | … | … | … |
- **本地存储/缓存（如适用）**：方案（SQL/NoSQL/Key-Value）、索引、迁移（版本 → 版本）、回滚与恢复
- **隐私与敏感信息**：脱敏/加密/访问审计

 - **示例（可删）**
   
   ```dart
   // 枚举/状态
   enum Status { pending, approved, rejected, unknown }

   // 请求/响应模型（与后端字段一一对应，含可空性/默认值）
   class ExampleRequest { /* fields */ }
   class ExampleResponse { /* fields */ }
   ```

---

## 7. 合同与集成（Contracts & Integrations）

> **不假设协议**。可为 HTTP/gRPC/GraphQL/事件总线/推送等，按实际项目确定。

- **接口清单（或事件/消息）**  
  | 名称 | 通信方式 | 请求模型 | 响应/事件负载 | 鉴权/限流/幂等 | 错误语义 |
  |------|----------|----------|---------------|-----------------|----------|
  | … | HTTP/… | `RequestX` | `ResponseY` | … | … |
- **失败与降级策略**：重试/退避、兜底提示、离线缓存、读写隔离
- **灰度与回滚**：开关位、按渠道/人群/环境灰度

 - **错误模型与处理（建议）**
   - 错误分类：`network`、`validation`、`rate_limit`、`server`、`unknown`
   - 异常封装：`AppException{ type, message, cause }`
   - UX 策略：可重试、局部失败不致命、记录失败项支持单独重试

---

## 8. UI 与交互（UI/UX & Accessibility）

- **页面/组件清单**  
  | 页面/组件 | 责任 | 关键交互 | 输入/输出 | 空态/加载/错误 |
  |-----------|------|----------|-----------|----------------|
  | … | … | … | … | … |
- **设计一致性**：主题/字号/间距/色板由项目样式系统驱动
- **无障碍（A11y）/国际化（i18n）**：文案结构、RTL 支持、读屏描述
 - **交互规则**：点击范围/触发条件、显示优先级（状态/标签冲突时的决策）、输入限制（最大长度/合法字符）

---

## 9. 校验与验收（Verification & Acceptance）

- **测试层次**：单元/集成/界面行为/E2E（按项目实际工具）
- **关键用例表**（与 `requirements.md` 对齐）  
  | 编号 | 场景 | 前置 | 步骤 | 期望 | 验收方式 |
  |-----:|------|------|------|------|----------|
  | T-01 | … | … | … | … | 录屏/日志/埋点 |
- **门禁/阈值**：静态检查、最低覆盖目标（如达不到，给出补救计划）
- **手测清单**：链接或内嵌
 - **当缺乏自动化测试时**：
   - 静态检查通过（analyze/lint）
   - 代码格式校验（format）
   - 提供可复现的手动用例：前置条件/步骤/期望/截图或录屏

---

## 10. 性能与资源（Performance & Footprint）

- **关键路径**：渲染/列表/媒体/网络/存储/启动
- **目标**：首屏时间、帧率掉帧、接口时延、内存峰值
- **优化点**：分页/预取/去抖/差分刷新/压缩/并发策略
- **容量治理**：缓存上限/清理策略/磁盘与内存水位

---

## 11. 安全与隐私（Security & Privacy）

- **数据分类与保护**：静态加密/传输加密/密钥管理
- **权限/鉴权/会话**：最小权限、刷新与过期处理
- **日志与审计**：脱敏、PII 控制、留存周期
- **合规**：本地政策/GDPR/行业规范（如适用）

---

## 12. 观测与运维（Observability & Ops）

- **埋点/指标**：转化、失败类型、耗时、重试次数
- **日志级别与聚合**：info/warn/error/fatal；异常聚合策略
- **告警阈值**：错误率、超时、卡顿
- **可视化**：Dashboard/链路追踪（如有）

---

## 13. 影响评估（Impact & Change List）

- **改动清单**：受影响模块/接口/脚本/配置
- **兼容性**：默认行为、旧版本兼容、迁移期策略
- **第三方/团队协作**：对后端/测试/发布/运营的依赖与协同点

 - **集成点与修改点（落地指引）**
   - 受影响文件路径清单（新增/修改/删除）
   - UI/状态管理/服务层需要扩展的条目
   - 构建脚本、资源、国际化文件的变更

---

## 14. 迁移与回滚（Migration & Rollback）

- **数据迁移**：脚本/回填/校验/回滚路径
- **配置/版本控制**：开关默认关闭，验证后开启；版本与渠道策略
- **切换计划**：按环境/渠道灰度 → 全量；精确回滚步骤

---

## 15. 发布与交付（Release & Delivery）

- **分支策略**：`spec/<name>` → `feature/<name>` → 合入主干
- **CI/CD 要点**：构建、签名、制品归档、渠道（内测/生产）
- **发布清单**：变更日志、已知问题、风险提示、应急手册
 - **配置管理**：环境参数/构建模式、API 基址/鉴权方式、特性开关默认值

---

## 16. 风险与权衡（Risks & Trade-offs）

| 风险 | 影响 | 可能性 | 缓解措施 | 触发回滚条件 |
|------|------|--------|----------|--------------|
| … | … | 低/中/高 | … | … |

---

## 17. 代码组织与约定（Code Map & Conventions）

> **沿用项目现有风格与目录**。如需新增目录/约定，**最小化变更**并说明理由。
> **遵循现有仓库结构，仅在必要处新增**
> **示例：features/<feature>/{ui|logic|data}/… 或 modules/<domain>/…**

---

## 18. 未来增强与技术债务（Future Enhancements & Tech Debt）

- 可能的扩展能力：`<批量操作/历史记录/离线/推送/进度可视化/…>`
- 技术债务清单与计划：自动化测试补齐、可抽取的公共模块、性能瓶颈的后续优化
