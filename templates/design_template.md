# 🧠 design.md — 方案设计规划模板

## 0. 元信息（Meta）

- Feature / Bug 名称：`<title>`
- Spec 路径：`spec/<feature-or-bug-name>/design.md`
- 版本 / 日期：`vX.Y · YYYY-MM-DD`
- 关联：`requirements.md`、`tasks.md`、项目文档
- 所有者 / 评审人：`<owner>` / `<reviewers>`
- 范围声明（Scope / Non-goals）
  - In Scope：`<本次包含>`
  - Out of Scope：`<明确不做>`

---

## 1. 项目基线与约束（Baseline & Constraints）

- 架构与平台：`<观察结果>`
- 模块边界与现有约定：`<观察结果>`
- 外部依赖与环境：`<依赖>`
- 关键约束：`<性能/安全/合规/版本/离线/发布>`
- 假设 & 待确认：`<列出>`

---

## 2. 目标与成功标准（Goals & Exit Criteria）

- 业务/用户目标：`<目标>`
- 技术目标：`<目标>`
- 退出标准：`<门槛>`

---

## 3. 渐进式交付策略（Progressive Strategy）

| Phase | 目标 | 主要内容 | 依赖 | 演示与验收 | 回滚点 |
|------:|------|----------|------|------------|--------|
| 1 | `<目标>` | `<内容>` | `<依赖>` | `<验收>` | `<回滚点>` |
| 2 | `<目标>` | `<内容>` | `<依赖>` | `<验收>` | `<回滚点>` |
| 3 | `<目标>` | `<内容>` | `<依赖>` | `<验收>` | `<回滚点>` |

---

## 4. 方案概要（Solution Overview）

- 设计思路：`<概要>`
- 影响面：`<模块/页面/接口/数据/配置>`
- 兼容性/降级：`<说明>`
- 可观测性：`<日志/埋点/指标/告警>`

- 技术栈（Tech Stack）：
  - 架构模式：`<Clean / MVVM / Redux / …>`
  - 状态管理：`<Riverpod / Provider / Bloc / …>`
  - 网络层：`<Dio / Retrofit / HTTP / …>`
  - 本地存储：`<SQLite/Floor / Hive / MMKV / …>`
  - UI 框架/样式：`<Flutter / 组件库 / 主题系统>`

- 分层视图（示意）：
  ```
  Presentation (UI + State) → Domain (Use Cases) → Data (Repo + Sources + Models)
  ```

---

## 5. 模块与调用关系（Modules & Flows）

- 模块清单（新/改/复用）
  | 模块 | 职责 | 新增/修改/复用 | 外部接口 |
  |------|------|----------------|----------|
  | … | … | … | … |
- 核心调用链：`<文字/ASCII/时序图>`
- 状态机（如需）：`<状态与转移>`

- 模块按层划分（路径占位）
  - Presentation：`lib/pages/...` 或 `lib/features/.../presentation/...`
  - Domain：`lib/features/.../domain/...`
  - Data：`lib/features/.../data/...`

---

## 6. 数据与模型（Data & Models）

- 领域实体：`<字段/约束>`
- DTO ↔ Domain 映射
  | 字段 | DTO | Domain | 默认值 | 兼容性 |
  |------|-----|--------|--------|--------|
  | … | … | … | … | … |
- 存储与迁移（如需）：`<方案>`
- 隐私与敏感：`<处理>`

- 请求/响应模型（占位）
  - 请求：`RequestX { … }`（JSON 序列化约定）
  - 响应：`ResponseY { … }`（字段默认值与可空性）

---

## 7. 合同与集成（Contracts & Integrations）

- 接口/事件清单
  | 名称 | 通信方式 | 请求 | 响应/负载 | 鉴权/幂等 | 错误语义 |
  |------|----------|------|-----------|-----------|----------|
  | … | … | … | … | … | … |
- 失败与降级：`<策略>`
- 灰度与回滚：`<策略>`

- 接口示例（占位）
  ```
  @POST("/api/.../endpoint")
  Future<BaseResponse<T>> action(@Body() RequestX param);
  ```

---

## 8. UI 与交互（UI/UX & A11y）

- 页面/组件清单
  | 页面/组件 | 责任 | 关键交互 | 输入/输出 | 空态/加载/错误 |
  |-----------|------|----------|-----------|----------------|
  | … | … | … | … | … |

---

## 9. 校验与验收（Verification & Acceptance）

- 测试层次：`<单元/集成/UI/E2E>`
- 关键用例表
  | 编号 | 场景 | 前置 | 步骤 | 期望 | 验收方式 |
  |-----:|------|------|------|------|----------|
  | … | … | … | … | … | … |

- 手测策略（占位）：`编译检查 (analyze/format)`、`关键路径手测用例`、`回归路径`

---

## 10. 性能与资源（Performance & Footprint）

- 关键路径：`<列出>`
- 目标：`<阈值>`
- 主要优化点：`<列出>`

---

## 11. 安全与隐私（Security & Privacy）

- 数据分类与保护：`<处理>`
- 权限/会话：`<处理>`
- 日志与审计：`<处理>`

---

## 12. 观测与运维（Observability & Ops）

- 指标与埋点：`<列出>`
- 日志与聚合：`<列出>`
- 告警阈值：`<列出>`

---

## 13. 影响评估（Impact & Change List）

- 改动清单：`<模块/接口/脚本/配置>`
- 兼容性：`<说明>`
- 协作依赖：`<说明>`

---

## 14. 迁移与回滚（Migration & Rollback）

- 数据迁移：`<脚本/回滚>`
- 配置/版本控制：`<策略>`
- 切换计划：`<方案>`

- 数据库迁移占位：
  ```
  Migration(X, Y, (db) async {
    await db.execute('ALTER TABLE <table> ADD COLUMN <col> <type> DEFAULT <v>');
  });
  ```

---

## 15. 发布与交付（Release & Delivery）

- 分支策略：`<说明>`
- CI/CD 要点：`<说明>`
- 发布清单：`<说明>`

---

## 16. 风险与权衡（Risks & Trade-offs）

| 风险 | 影响 | 可能性 | 缓解 | 回滚触发 |
|------|------|--------|------|----------|
| … | … | … | … | … |

---

## 17. 代码组织与约定（Code Map & Conventions）

- 目录与命名：`<对齐项目约定>`
- 注释与文档：`<对齐项目约定>`

---

## 18. 评审清单（Review Checklist）

- [ ] 与 `requirements.md` 对齐
- [ ] 每个 Phase 可运行/可测试/可回滚
- [ ] 兼容性与风险明确

---

## 19. 附录（Appendix）

- 术语表/参考资料/示例：`<可选>`
 - 后续增强（占位）：`<批量操作/历史/推送/离线/进度>`
