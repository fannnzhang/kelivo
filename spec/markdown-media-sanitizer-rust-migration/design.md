# ğŸ§  design.md â€” MarkdownMediaSanitizer è¿ç§» Rust æ–¹æ¡ˆ

## 0. å…ƒä¿¡æ¯ï¼ˆMetaï¼‰

- **Feature / Bug åç§°**ï¼šMarkdownMediaSanitizer æ ¸å¿ƒé€»è¾‘è¿ç§»åˆ° Rust
- **Spec è·¯å¾„**ï¼š`spec/markdown-media-sanitizer-rust-migration/design.md`
- **ç‰ˆæœ¬ / æ—¥æœŸ**ï¼šv1.0 Â· 2025-10-15
- **å…³è”**ï¼š`requirements.md`ã€`tasks.md`
- **æ‰€æœ‰è€… / è¯„å®¡äºº**ï¼šGemini / @kelivo
- **èŒƒå›´å£°æ˜ï¼ˆScope / Non-goalsï¼‰**
  - **In Scope**ï¼š
    - å°† `MarkdownMediaSanitizer` ä¸­çš„ `replaceInlineBase64Images` å’Œ `inlineLocalImagesToBase64` å‡½æ•°çš„æ ¸å¿ƒé€»è¾‘ç”¨ Rust å®ç°ã€‚
    - é€šè¿‡ `flutter_rust_bridge` (FRB) å°† Rust å®ç°æš´éœ²ç»™ Dart ç«¯ã€‚
    - Dart ç«¯çš„ `MarkdownMediaSanitizer` æ›´æ–°ä¸ºå¯¹ Rust å‡½æ•°çš„è°ƒç”¨å°è£…ã€‚
  - **Out of Scope**ï¼š
    - ä¸æ”¹å˜ `MarkdownMediaSanitizer` çš„ç°æœ‰æ¥å£å’Œè¡Œä¸ºã€‚
    - ä¸å¼•å…¥æ–°çš„ Markdown è§£æåº“ï¼Œä»…è¿ç§»ç°æœ‰é€»è¾‘ã€‚
    - æœ¬æ¬¡ä¸æ¶‰åŠå¯¹ `ChatService` ä¸­å…¶ä»–æ–‡ä»¶æ“ä½œï¼ˆå¦‚å­¤ç«‹æ–‡ä»¶æ¸…ç†ï¼‰çš„è¿ç§»ã€‚

---

## 1. é¡¹ç›®åŸºçº¿ä¸çº¦æŸï¼ˆBaseline & Constraintsï¼‰

- **æ¶æ„ä¸å¹³å°**ï¼šåº”ç”¨ä¸º Flutter Appï¼Œå·²é›†æˆ `flutter_rust_bridge`ï¼Œæ”¯æŒåœ¨ iOS, Android, macOS, Windows, Linux å¹³å°è°ƒç”¨ Rust ä»£ç ã€‚
- **æ¨¡å—è¾¹ç•Œä¸ç°æœ‰çº¦å®š**ï¼š`MarkdownMediaSanitizer` æ˜¯ä½äº `lib/utils/` ä¸‹çš„ç‹¬ç«‹å·¥å…·ç±»ï¼Œæ— å¤æ‚å¤–éƒ¨ä¾èµ–ã€‚Rust ä»£ç ç»Ÿä¸€å­˜æ”¾åœ¨ `rust/` ç›®å½•ä¸‹ã€‚
- **å¤–éƒ¨ä¾èµ–ä¸ç¯å¢ƒ**ï¼šRust ç«¯å¯ä¾èµ– `base64`, `regex`, `uuid` ç­‰æ ‡å‡†åº“æˆ–ç¤¾åŒºåº“æ¥è¾…åŠ©å®ç°ã€‚
- **å…³é”®çº¦æŸ**ï¼š
    - **æ€§èƒ½**: è¿ç§»åçš„å®ç°å¿…é¡»æ¯”çº¯ Dart ç‰ˆæœ¬æœ‰æ˜¾è‘—æ€§èƒ½æå‡ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤§æ–‡ä»¶å’Œå¤šæ–‡ä»¶åœºæ™¯ã€‚
    - **å…¼å®¹æ€§**: å¿…é¡»ä¿æŒä¸åŸåŠŸèƒ½ 100% çš„è¡Œä¸ºä¸€è‡´æ€§ã€‚
- **å‡è®¾ & å¾…ç¡®è®¤**ï¼šå‡è®¾ç°æœ‰çš„ FRB è®¾ç½®èƒ½å¤Ÿé¡ºåˆ©æ”¯æŒæ‰€éœ€çš„æ•°æ®ç±»å‹ï¼ˆ`String`, `Result<String, String>`)ã€‚

---

## 2. ç›®æ ‡ä¸æˆåŠŸæ ‡å‡†ï¼ˆGoals & Exit Criteriaï¼‰

- **æŠ€æœ¯ç›®æ ‡**ï¼š
  - å°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä» Dart ç§»è‡³ Rustï¼Œé™ä½ Dart Isolate çš„è´Ÿè½½ã€‚
  - æå‡ Markdown å›¾ç‰‡å¤„ç†çš„æ‰§è¡Œæ•ˆç‡ã€‚
- **é€€å‡ºæ ‡å‡†**ï¼š
  - æ‰€æœ‰åœ¨ `requirements.md` ä¸­å®šä¹‰çš„éªŒæ”¶æ ‡å‡†å‡å·²æ»¡è¶³ã€‚
  - æ€§èƒ½åŸºå‡†æµ‹è¯•è¡¨æ˜ï¼Œæ–°å®ç°åœ¨ç›®æ ‡åœºæ™¯ä¸‹æœ‰è‡³å°‘ 30% çš„æ€§èƒ½æå‡ã€‚
  - ä»£ç é€šè¿‡æ‰€æœ‰ CI æ£€æŸ¥ï¼ŒåŒ…æ‹¬æ ¼å¼åŒ–ã€é™æ€åˆ†æå’Œå•å…ƒæµ‹è¯•ã€‚

---

## 3. æ¸è¿›å¼äº¤ä»˜ç­–ç•¥ï¼ˆProgressive Strategyï¼‰

| Phase | ç›®æ ‡ | ä¸»è¦å†…å®¹ | ä¾èµ– | æ¼”ç¤ºä¸éªŒæ”¶ | å›æ»šç‚¹ |
|------:|------|----------|------|------------|--------|
| 1 | Rust æ ¸å¿ƒé€»è¾‘å®ç° | åœ¨ `rust/src/api/` ä¸‹åˆ›å»ºæ–°æ¨¡å—ï¼Œå®ç° `replace_inline_base64_images` å’Œ `inline_local_images_to_base64` çš„ Rust ç‰ˆæœ¬ã€‚ä¸ºè¿™ä¸¤ä¸ªå‡½æ•°ç¼–å†™çº¯ Rust çš„å•å…ƒæµ‹è¯•ã€‚ | `requirements.md` | å•å…ƒæµ‹è¯•é€šè¿‡ | ç§»é™¤ Rust æ¨¡å—ä»£ç  |
| 2 | FRB é›†æˆä¸ Dart è°ƒç”¨ | åœ¨ FRB çš„ `api.rs` ä¸­æš´éœ²æ–°çš„ Rust å‡½æ•°ã€‚è¿è¡Œä»£ç ç”Ÿæˆå™¨ã€‚åœ¨ `lib/utils/markdown_media_sanitizer.dart` ä¸­ï¼Œä¿®æ”¹åŸæœ‰å‡½æ•°å®ç°ï¼Œæ”¹ä¸ºè°ƒç”¨ç”Ÿæˆçš„ Rust æ¥å£ã€‚ | Phase 1 | Dart ç«¯çš„é›†æˆæµ‹è¯•é€šè¿‡ | æ¢å¤ `markdown_media_sanitizer.dart` çš„åŸå®ç° |
| 3 | æ€§èƒ½éªŒè¯ä¸æ¸…ç† | ç¼–å†™åŸºå‡†æµ‹è¯•ï¼Œå¯¹æ¯”è¿ç§»å‰ååœ¨å¤„ç†å¤§ base64 å­—ç¬¦ä¸²å’Œå¤šä¸ªæœ¬åœ°å›¾ç‰‡æ—¶çš„æ€§èƒ½å·®å¼‚ã€‚ç¡®è®¤æ€§èƒ½è¾¾æ ‡åï¼Œç§»é™¤ Dart ä¸­ä¸å†éœ€è¦çš„æ—§é€»è¾‘ä»£ç ã€‚ | Phase 2 | æ€§èƒ½æµ‹è¯•æŠ¥å‘Š | è‹¥æ€§èƒ½ä¸è¾¾æ ‡ï¼Œå›æ»šåˆ° Phase 2 çš„ Dart å®ç° |

---

## 4. æ–¹æ¡ˆæ¦‚è¦ï¼ˆSolution Overviewï¼‰

- **è®¾è®¡æ€è·¯**ï¼šé‡‡ç”¨â€œæ¡¥æ¥â€æ¨¡å¼ï¼Œå°† `MarkdownMediaSanitizer` çš„ Dart å®ç°æ”¹é€ ä¸ºè°ƒç”¨å±‚ï¼Œæ ¸å¿ƒå¤„ç†é€»è¾‘ä¸‹æ²‰åˆ° Rustã€‚Dart è´Ÿè´£ä¼ é€’æ•°æ®å’Œæ¥æ”¶ç»“æœï¼ŒRust è´Ÿè´£æ‰€æœ‰è®¡ç®—å’Œæ–‡ä»¶æ“ä½œã€‚
- **å½±å“é¢**ï¼š
  - `lib/utils/markdown_media_sanitizer.dart`: å®ç°å°†è¢«æ›¿æ¢ã€‚
  - `rust/src/api/`: æ–°å¢ Rust æ¨¡å—ã€‚
  - `rust/src/frb_generated.rs`: å°†è¢« FRB å·¥å…·æ›´æ–°ã€‚
- **å…¼å®¹æ€§/é™çº§**ï¼šæ¥å£ä¿æŒä¸å˜ï¼Œå¯¹è°ƒç”¨æ–¹é€æ˜ã€‚å¦‚æœ Rust å®ç°å¤±è´¥ï¼Œå‡½æ•°å°†è¿”å›é”™è¯¯ï¼Œç”± Dart ç«¯å¤„ç†ï¼Œæœ€å·®æƒ…å†µä¸‹å¯ä¿ç•™åŸå§‹è¾“å…¥ï¼Œç¡®ä¿åº”ç”¨ä¸å´©æºƒã€‚
- **å¯è§‚æµ‹æ€§**ï¼šåœ¨ Rust å‡½æ•°çš„å…³é”®è·¯å¾„ï¼ˆå¦‚æ–‡ä»¶è¯»å†™å¤±è´¥ï¼‰å’Œ Dart è°ƒç”¨è¾¹ç•Œæ·»åŠ æ—¥å¿—ã€‚

---

## 5. æ¨¡å—ä¸è°ƒç”¨å…³ç³»ï¼ˆModules & Flowsï¼‰

- **æ¨¡å—æ¸…å•**
| æ¨¡å— | èŒè´£ | æ–°å¢/ä¿®æ”¹/å¤ç”¨ |
|------|------|----------------|
| `rust/src/api/markdown_sanitizer.rs` | å®ç° Markdown å›¾ç‰‡å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ | æ–°å¢ |
| `rust/src/api/mod.rs` | æš´éœ² `markdown_sanitizer` æ¨¡å— | ä¿®æ”¹ |
| `lib/utils/markdown_media_sanitizer.dart` | è°ƒç”¨ Rust å‡½æ•°ï¼Œå¤„ç† Dart ä¸ Rust çš„æ•°æ®äº¤äº’ | ä¿®æ”¹ |
| `lib/config/feature_flags.dart` | Feature Flag é…ç½®ï¼Œæ§åˆ¶ Mock/Real åˆ‡æ¢ | æ–°å¢ |

- **æ ¸å¿ƒè°ƒç”¨é“¾**ï¼š
  `Dart (UI/Service)` â†’ `MarkdownMediaSanitizer.replace...()` â†’ `RustLib.api.replace...()` â†’ `Rust (markdown_sanitizer.rs)`

---

## 7. åˆåŒä¸é›†æˆï¼ˆContracts & Integrationsï¼‰

- **æ¥å£æ¸…å•**
  | åç§° | é€šä¿¡æ–¹å¼ | è¯·æ±‚ | å“åº”/è´Ÿè½½ | é”™è¯¯è¯­ä¹‰ |
  |------|----------|------|-----------|----------|
  | `replace_inline_base64_images` | FRB | `markdown: String` | `Result<String, String>` | `Err` åŒ…å«é”™è¯¯ä¿¡æ¯ |
  | `inline_local_images_to_base64` | FRB | `markdown: String` | `Result<String, String>` | `Err` åŒ…å«é”™è¯¯ä¿¡æ¯ |

---

## 9. æ ¡éªŒä¸éªŒæ”¶ï¼ˆVerification & Acceptanceï¼‰

- **æµ‹è¯•å±‚æ¬¡**ï¼š
  - **å•å…ƒæµ‹è¯•**: åœ¨ Rust ç«¯å¯¹æ ¸å¿ƒè§£æå’Œæ–‡ä»¶æ“ä½œé€»è¾‘è¿›è¡Œæµ‹è¯•ã€‚
  - **é›†æˆæµ‹è¯•**: åœ¨ Dart ç«¯ç¼–å†™æµ‹è¯•ï¼Œç¡®ä¿ FRB è°ƒç”¨æˆåŠŸï¼Œä¸”ç«¯åˆ°ç«¯è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚
  - **åŸºå‡†æµ‹è¯•**: `test/benchmark/markdown_sanitizer_benchmark.dart` è¯„ä¼° Mock ä¸ Real æ€§èƒ½ï¼Œç»“æœè®°å½•äº `docs/perf/markdown_sanitizer.md`ã€‚
- **å…³é”®ç”¨ä¾‹è¡¨**
  | ç¼–å· | åœºæ™¯ | æ­¥éª¤ | æœŸæœ› |
  |-----:|------|------|------|
  | 1 | å•ä¸ª Base64 å›¾ç‰‡ | è°ƒç”¨ `replaceInlineBase64Images` | å›¾ç‰‡è¢«å­˜ä¸ºæ–‡ä»¶ï¼Œè·¯å¾„æ›¿æ¢æ­£ç¡® |
  | 2 | å¤šä¸ª Base64 å›¾ç‰‡ | è°ƒç”¨ `replaceInlineBase64Images` | æ‰€æœ‰å›¾ç‰‡å‡è¢«æ­£ç¡®å¤„ç† |
  | 3 | å•ä¸ªæœ¬åœ°å›¾ç‰‡ | è°ƒç”¨ `inlineLocalImagesToBase64` | å›¾ç‰‡è¢«å†…è”ä¸º Base64 |
  | 4 | æ··åˆå†…å®¹ | è°ƒç”¨ä»»ä¸€å‡½æ•° | ä»…ç›®æ ‡å›¾ç‰‡è¢«å¤„ç†ï¼Œå…¶ä»–å†…å®¹ä¸å˜ |
  | 5 | é”™è¯¯å¤„ç† | è¾“å…¥æ— æ•ˆæ•°æ®æˆ–æ¨¡æ‹Ÿæ–‡ä»¶å¤±è´¥ | å‡½æ•°è¿”å› `Err`ï¼ŒDart ç«¯èƒ½æ•è· |

---

## 14. è¿ç§»ä¸å›æ»šï¼ˆMigration & Rollbackï¼‰

- **åˆ‡æ¢è®¡åˆ’**ï¼šé€šè¿‡ä¿®æ”¹ `lib/utils/markdown_media_sanitizer.dart` çš„å®ç°æ¥å®Œæˆåˆ‡æ¢ã€‚æ— éœ€å¤æ‚çš„ç‰ˆæœ¬æ§åˆ¶æˆ–ç°åº¦ã€‚
- **å›æ»š**ï¼šå¦‚æœ Phase 2 æˆ– 3 å‡ºç°é—®é¢˜ï¼Œåªéœ€å°† `lib/utils/markdown_media_sanitizer.dart` çš„å†…å®¹æ¢å¤åˆ°è¿ç§»å‰çš„ç‰ˆæœ¬å³å¯å®Œæˆå›æ»šã€‚

---

## 16. é£é™©ä¸æƒè¡¡ï¼ˆRisks & Trade-offsï¼‰

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£ | å›æ»šè§¦å‘ |
|------|------|--------|------|----------|
| FRB é›†æˆé—®é¢˜ | é˜»å¡å¼€å‘ | ä½ | éµå¾ªç°æœ‰ FRB å®è·µï¼Œå‚è€ƒå·²æœ‰å®ç° | æ— æ³•åœ¨2å¤©å†…è§£å†³ | 
| æ€§èƒ½ä¸è¾¾æ ‡ | æœªè¾¾åˆ°ä¼˜åŒ–ç›®æ ‡ | ä¸­ | åœ¨ Rust ç«¯ä¼˜åŒ–æ–‡ä»¶è¯»å†™å’Œæ­£åˆ™æ€§èƒ½ | åŸºå‡†æµ‹è¯•ç»“æœä½äºé¢„æœŸ |
| å¹³å°å…¼å®¹æ€§é—®é¢˜ | åœ¨ç‰¹å®šå¹³å°ï¼ˆå¦‚ iOS æ²™ç®±ï¼‰å‡ºç°æ–‡ä»¶è·¯å¾„é—®é¢˜ | ä¸­ | åœ¨ Rust ç«¯å’Œ Dart ç«¯å¯¹è·¯å¾„è¿›è¡Œä¸¥æ ¼æµ‹è¯•å’Œé€‚é… | ç‰¹å®šå¹³å°æµ‹è¯•å¤±è´¥ |

---

## 17. ä»£ç ç»„ç»‡ä¸çº¦å®šï¼ˆCode Map & Conventionsï¼‰

- **ç›®å½•ä¸å‘½å**ï¼š
  - Rust æ¨¡å—: `rust/src/api/markdown_sanitizer.rs`
  - Rust å‡½æ•°: `replace_inline_base64_images`, `inline_local_images_to_base64`
- **æ³¨é‡Šä¸æ–‡æ¡£**ï¼šä¸ºå…¬å¼€çš„ Rust å‡½æ•°æ·»åŠ æ–‡æ¡£æ³¨é‡Šã€‚

---

## 18. è¯„å®¡æ¸…å•ï¼ˆReview Checklistï¼‰

- [x] ä¸ `requirements.md` å¯¹é½
- [x] æ¯ä¸ª Phase å¯è¿è¡Œ/å¯æµ‹è¯•/å¯å›æ»š
- [x] å…¼å®¹æ€§ä¸é£é™©æ˜ç¡®
