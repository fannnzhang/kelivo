# ğŸ§  design.md â€” Google Auth JWT ç­¾åè¿ç§»è‡³ Rust æ–¹æ¡ˆè®¾è®¡

## 0. å…ƒä¿¡æ¯ï¼ˆMetaï¼‰

- **Feature åç§°**ï¼š`feat(rust): migrate-google-auth-jwt-signing`
- **Spec è·¯å¾„**ï¼š`spec/google-auth-rust-migration/design.md`
- **ç‰ˆæœ¬ / æ—¥æœŸ**ï¼šv1.0 Â· 2025-10-15
- **å…³è”**ï¼š`requirements.md`
- **æ‰€æœ‰è€… / è¯„å®¡äºº**ï¼šGemini
- **èŒƒå›´å£°æ˜ï¼ˆScope / Non-goalsï¼‰**
  - **In Scope**ï¼šå°† `google_service_account_auth.dart` ä¸­ä½¿ç”¨ `jose` åŒ…ç”Ÿæˆ JWT çš„é€»è¾‘æ›¿æ¢ä¸º Rust å®ç°ã€‚
  - **Out of Scope**ï¼šè®¤è¯æµç¨‹ä¸­çš„ HTTP è¯·æ±‚ã€Token ç¼“å­˜é€»è¾‘ã€ä»¥åŠé¡¹ç›®å…¶ä»–éƒ¨åˆ†çš„ä»»ä½•ä»£ç ã€‚

---

## 1. é¡¹ç›®åŸºçº¿ä¸çº¦æŸï¼ˆBaseline & Constraintsï¼‰

- **æ¶æ„ä¸å¹³å°**ï¼šé¡¹ç›®å·²é›†æˆ Flutter Rust Bridge (FRB)ï¼Œä¸º Dart ä¸ Rust ä¹‹é—´çš„é€šä¿¡æä¾›äº†ç°æœ‰é€šé“ã€‚
- **æ¨¡å—è¾¹ç•Œä¸ç°æœ‰çº¦å®š**ï¼šRust é€»è¾‘åº”å°è£…åœ¨ `rust/src/api/` ç›®å½•ä¸‹çš„æ–°æ¨¡å—ä¸­ï¼Œå¹¶éµå¾ªç°æœ‰çš„ FRB å‡½æ•°æš´éœ²æ¨¡å¼ã€‚
- **å¤–éƒ¨ä¾èµ–ä¸ç¯å¢ƒ**ï¼šDart ä¾§ä¾èµ– `http` åŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ã€‚Rust ä¾§å°†å¼•å…¥æ–°çš„åŠ å¯†å’Œ JWT ç›¸å…³ Crateã€‚
- **å…³é”®çº¦æŸ**ï¼šæ–°çš„ Rust å®ç°å¿…é¡»åœ¨æ‰€æœ‰ç›®æ ‡å¹³å°ï¼ˆiOS, Android, Web, Desktopï¼‰ä¸Šè¡Œä¸ºä¸€è‡´ã€‚å¿…é¡»ä½¿ç”¨ç»è¿‡ç¤¾åŒºå®‰å…¨å®¡è®¡çš„ã€ç”Ÿäº§çº§çš„ Rust Crateã€‚

---

## 2. ç›®æ ‡ä¸æˆåŠŸæ ‡å‡†ï¼ˆGoals & Exit Criteriaï¼‰

- **æŠ€æœ¯ç›®æ ‡**ï¼š
  1. ç§»é™¤ Dart `jose` åŒ…åœ¨ JWT ç­¾ååœºæ™¯çš„ä½¿ç”¨ï¼Œæ›¿æ¢ä¸ºæ›´å®‰å…¨ã€æ›´é«˜æ€§èƒ½çš„ Rust åŸç”Ÿå®ç°ã€‚
  2. éªŒè¯é€šè¿‡ FRB è¿›è¡ŒåŠ å¯†æ“ä½œçš„å¯è¡Œæ€§ä¸æ€§èƒ½ä¼˜åŠ¿ã€‚
- **é€€å‡ºæ ‡å‡†**ï¼š
  1. JWT ç­¾åé€»è¾‘åœ¨ Rust ä¸­å®ç°å¹¶é€šè¿‡å•å…ƒæµ‹è¯•ã€‚
  2. Dart ä»£ç æˆåŠŸé›†æˆ Rust å‡½æ•°ï¼Œå¹¶é€šè¿‡é›†æˆæµ‹è¯•ï¼ŒGoogle æœåŠ¡è´¦æˆ·è®¤è¯æµç¨‹å¯æ­£å¸¸å·¥ä½œã€‚
  3. æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆå¯é€‰ï¼‰è¡¨æ˜ Rust å®ç°ä¸åŠ£äºï¼ˆå¹¶ä¼˜äºï¼‰Dart å®ç°ã€‚

---

## 3. æ¸è¿›å¼äº¤ä»˜ç­–ç•¥ï¼ˆProgressive Strategyï¼‰

| Phase | ç›®æ ‡ | ä¸»è¦å†…å®¹ | ä¾èµ– | æ¼”ç¤ºä¸éªŒæ”¶ | å›æ»šç‚¹ |
|------:|------|----------|------|------------|--------|
| 1 | åŠŸèƒ½å®ç°ä¸é›†æˆ | 1. å¼€å‘ Rust JWT ç­¾åå‡½æ•°ã€‚<br>2. ç¼–å†™ Rust å•å…ƒæµ‹è¯•ã€‚<br>3. åœ¨ Dart ä¸­æ›¿æ¢åŸæœ‰é€»è¾‘ã€‚<br>4. è¿è¡Œé›†æˆæµ‹è¯•éªŒè¯ç«¯åˆ°ç«¯æµç¨‹ã€‚ | æ—  | æ¼”ç¤ºè®¤è¯æµç¨‹æˆåŠŸè·å– Token | åˆ‡æ¢å›ä½¿ç”¨ `jose` åŒ…çš„æ—§ä»£ç å®ç°ã€‚ |

---

## 4. æ–¹æ¡ˆæ¦‚è¦ï¼ˆSolution Overviewï¼‰

- **è®¾è®¡æ€è·¯**ï¼šæœ¬æ–¹æ¡ˆé‡‡ç”¨â€œç²¾å‡†ä¸‹æ²‰â€ç­–ç•¥ï¼Œä»…å°†è®¡ç®—æœ€å¯†é›†ã€å®‰å…¨æœ€æ•æ„Ÿçš„ JWT ç­¾åæ“ä½œè¿ç§»åˆ° Rustã€‚Dart å±‚ç»§ç»­è´Ÿè´£æµç¨‹ç¼–æ’ï¼ˆå¦‚å‚æ•°å‡†å¤‡ã€HTTP è°ƒç”¨ã€ç¼“å­˜ç®¡ç†ï¼‰ï¼ŒRust å±‚åˆ™ä½œä¸ºä¸€ä¸ªçº¯ç²¹çš„ã€æ— å‰¯ä½œç”¨çš„åŠ å¯†è®¡ç®—å•å…ƒã€‚è¿™ç§è®¾è®¡å°†æ”¹åŠ¨èŒƒå›´é™è‡³æœ€ä½ï¼ŒåŒæ—¶æœ€å¤§åŒ– Rust çš„ä¼˜åŠ¿ã€‚
- **å½±å“é¢**ï¼š
  - **ä¿®æ”¹**: `lib/core/services/api/google_service_account_auth.dart`
  - **æ–°å¢**: `rust/src/api/google_auth.rs` (æˆ–ç±»ä¼¼åç§°)
  - **ä¾èµ–**: `Cargo.toml` å°†æ–°å¢ `jsonwebtoken`, `chrono`, `serde` ç­‰ crateã€‚
- **å…¼å®¹æ€§/é™çº§**ï¼šæ— å…¼å®¹æ€§é—®é¢˜ã€‚ç”±äºæ˜¯çº¯é€»è¾‘æ›¿æ¢ï¼Œå¯é€šè¿‡ä»£ç æ³¨é‡Šæˆ–åˆ†æ”¯è½»æ¾å›æ»šåˆ°æ—§å®ç°ã€‚

---

## 5. æ¨¡å—ä¸è°ƒç”¨å…³ç³»ï¼ˆModules & Flowsï¼‰

- **æ¨¡å—æ¸…å•**
  | æ¨¡å— | èŒè´£ | æ–°å¢/ä¿®æ”¹/å¤ç”¨ | å¤–éƒ¨æ¥å£ |
  |------|------|----------------|----------|
  | `google_service_account_auth.dart` | ç¼–æ’è®¤è¯æµç¨‹ï¼Œè°ƒç”¨ Rust è·å– JWT | ä¿®æ”¹ | `getAccessToken()` |
  | `rust/src/api/google_auth.rs` | åˆ›å»ºå¹¶ç­¾å JWT | æ–°å¢ | `create_google_auth_jwt()` |

- **æ ¸å¿ƒè°ƒç”¨é“¾**ï¼š
  `Dart:getAccessToken()` â†’ `Rust:create_google_auth_jwt()` â†’ `Dart:getAccessToken()` â†’ `http.post()`

---

## 6. æ•°æ®ä¸æ¨¡å‹ï¼ˆData & Modelsï¼‰

- **é¢†åŸŸå®ä½“**ï¼šJWT Claims
  - åœ¨ Rust å‡½æ•°å†…éƒ¨å®šä¹‰ï¼Œç”¨äºåºåˆ—åŒ–ä¸º JWT payloadã€‚
  ```rust
  #[derive(Debug, Serialize, Deserialize)]
  struct Claims {
      iss: String,   // issuer
      scope: String, // space-separated scopes
      aud: String,   // audience
      iat: i64,      // issued at (epoch seconds)
      exp: i64,      // expiration (epoch seconds)
  }
  ```
- **éšç§ä¸æ•æ„Ÿ**ï¼š`private_key` ä½œä¸ºå­—ç¬¦ä¸²åœ¨ Dart å’Œ Rust ä¹‹é—´ä¼ é€’ã€‚åœ¨ Rust ç«¯ï¼Œå®ƒä»…åœ¨å‡½æ•°ä½œç”¨åŸŸå†…ç”¨äºè§£ç å’Œç­¾åï¼Œä¸ä¼šè¢«å­˜å‚¨æˆ–æ³„éœ²ã€‚

---

## 7. åˆåŒä¸é›†æˆï¼ˆContracts & Integrationsï¼‰

- **æ¥å£/äº‹ä»¶æ¸…å•**
  | åç§° | é€šä¿¡æ–¹å¼ | è¯·æ±‚ (å‚æ•°) | å“åº”/è´Ÿè½½ | é‰´æƒ/å¹‚ç­‰ | é”™è¯¯è¯­ä¹‰ |
  |------|----------|------|-----------|-----------|----------|
  | `create_google_auth_jwt` | FRB (Rust) | `private_key: String`, `client_email: String`, `token_uri: String`, `scopes: Vec<String>` | `Result<String, String>` | N/A | è¿”å›åŒ…å«é”™è¯¯ä¿¡æ¯çš„ `Err` |

- **æ¥å£ç¤ºä¾‹ï¼ˆFRBï¼‰**
  ```rust
  // In rust/src/api/google_auth.rs
  pub fn create_google_auth_jwt(
      private_key_pem: String,
      client_email: String,
      token_uri: String,
      scopes: Vec<String>,
  ) -> anyhow::Result<String> {
      // ... implementation ...
  }
  ```

---

## 9. æ ¡éªŒä¸éªŒæ”¶ï¼ˆVerification & Acceptanceï¼‰

- **æµ‹è¯•å±‚æ¬¡**ï¼šå•å…ƒæµ‹è¯• (Rust), é›†æˆæµ‹è¯• (Flutter)
- **å…³é”®ç”¨ä¾‹è¡¨**
  | ç¼–å· | åœºæ™¯ | å‰ç½® | æ­¥éª¤ | æœŸæœ› | éªŒæ”¶æ–¹å¼ |
  |-----:|------|------|------|------|----------|
  | 1.1 | Rust å•å…ƒæµ‹è¯• | æä¾›æœ‰æ•ˆçš„ PEM ç§é’¥å’Œå‚æ•° | è°ƒç”¨ `create_google_auth_jwt` | è¿”å›ä¸€ä¸ªæ ¼å¼æ­£ç¡®çš„ JWT å­—ç¬¦ä¸² | `cargo test` |
  | 1.2 | Rust å•å…ƒæµ‹è¯• | æä¾›æ— æ•ˆçš„ PEM ç§é’¥ | è°ƒç”¨ `create_google_auth_jwt` | è¿”å›åŒ…å«â€œInvalidKeyâ€ç­‰ä¿¡æ¯çš„ `Err` | `cargo test` |
  | 2.1 | Flutter é›†æˆæµ‹è¯• | Mock HTTP Client, æä¾›æœ‰æ•ˆå‡­è¯ | è°ƒç”¨ `GoogleServiceAccountAuth.getAccessToken` | å‡½æ•°æˆåŠŸè¿”å› mock tokenï¼Œæ— å¼‚å¸¸ | `flutter test` |

---

## 11. å®‰å…¨ä¸éšç§ï¼ˆSecurity & Privacyï¼‰

- **æ•°æ®åˆ†ç±»ä¸ä¿æŠ¤**ï¼š`private_key` è¢«è§†ä¸ºé«˜åº¦æ•æ„Ÿæ•°æ®ã€‚å®ƒåœ¨å†…å­˜ä¸­ä»¥å­—ç¬¦ä¸²å½¢å¼å­˜åœ¨ï¼Œä»…åœ¨éœ€è¦æ—¶ä¼ é€’ç»™ Rust å‡½æ•°ï¼ŒRust å‡½æ•°å¤„ç†åç«‹å³é”€æ¯å…¶ä½œç”¨åŸŸå†…çš„å‰¯æœ¬ï¼Œç¬¦åˆæœ€å°æƒé™å’Œæœ€çŸ­ç”Ÿå‘½å‘¨æœŸåŸåˆ™ã€‚

---

## 16. é£é™©ä¸æƒè¡¡ï¼ˆRisks & Trade-offsï¼‰

| é£é™© | å½±å“ | å¯èƒ½æ€§ | ç¼“è§£ | å›æ»šè§¦å‘ |
|------|------|--------|------|----------|
| Rust Crate å­˜åœ¨å®‰å…¨æ¼æ´ | å¯èƒ½å¯¼è‡´ç§é’¥æ³„éœ²æˆ–ç­¾åè¢«ä¼ªé€  | ä½ | é€‰æ‹©å¹¿æ³›ä½¿ç”¨ã€ç§¯æç»´æŠ¤ä¸”ç»è¿‡å®¡è®¡çš„ Crate (å¦‚ `jsonwebtoken`) | å‘ç°ä¸¥é‡å®‰å…¨å…¬å‘Š |
| æ€§èƒ½ä¸è¾¾é¢„æœŸ | å½±å“è®¤è¯é€Ÿåº¦ | æä½ | Rust çš„åŠ å¯†æ€§èƒ½é€šå¸¸è¿œè¶… Dartã€‚ç¼–å†™åŸºå‡†æµ‹è¯•éªŒè¯ã€‚ | æ€§èƒ½ä¸¥é‡å·®äº Dart |

---

## 17. ä»£ç ç»„ç»‡ä¸çº¦å®šï¼ˆCode Map & Conventionsï¼‰

- **ç›®å½•ä¸å‘½å**ï¼š
  - æ–°å¢ Rust æ–‡ä»¶ï¼š`rust/src/api/google_auth.rs`
  - åœ¨ `rust/src/api/mod.rs` ä¸­å£°æ˜æ–°æ¨¡å— `pub mod google_auth;`
  - Dart è°ƒç”¨ä¾§ä¿æŒä¸å˜ã€‚
